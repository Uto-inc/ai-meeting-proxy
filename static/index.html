<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Meeting Proxy - Admin</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Meiryo", sans-serif;
  background: #f5f5f5; color: #333; line-height: 1.6;
}
.header {
  background: #1a1a2e; color: #fff; padding: 16px 24px;
  display: flex; align-items: center; gap: 12px;
}
.header h1 { font-size: 18px; font-weight: 600; }
.header .status-dot {
  width: 10px; height: 10px; border-radius: 50%; background: #666;
  margin-left: auto;
}
.header .status-dot.ok { background: #4caf50; }
.tabs {
  display: flex; background: #16213e; border-bottom: 2px solid #0f3460;
}
.tab-btn {
  padding: 10px 24px; background: none; border: none; color: #aaa;
  cursor: pointer; font-size: 14px; font-family: inherit;
  border-bottom: 2px solid transparent; transition: all 0.2s;
}
.tab-btn:hover { color: #ddd; background: rgba(255,255,255,0.05); }
.tab-btn.active { color: #fff; border-bottom-color: #e94560; }
.container { max-width: 960px; margin: 0 auto; padding: 24px; }
.panel { display: none; }
.panel.active { display: block; }
.card {
  background: #fff; border-radius: 8px; padding: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px;
}
.card h2 { font-size: 16px; margin-bottom: 12px; color: #1a1a2e; }
.card h3 { font-size: 14px; margin-bottom: 8px; color: #555; }
label { display: block; font-size: 13px; color: #555; margin-bottom: 4px; font-weight: 500; }
textarea {
  width: 100%; min-height: 300px; padding: 12px;
  font-family: "SF Mono", "Fira Code", "Consolas", monospace;
  font-size: 13px; line-height: 1.5; border: 1px solid #ddd;
  border-radius: 6px; resize: vertical; background: #fafafa;
}
textarea:focus { outline: none; border-color: #0f3460; background: #fff; }
input[type="text"], input[type="number"], select {
  width: 100%; padding: 8px 12px; border: 1px solid #ddd;
  border-radius: 6px; font-size: 14px; font-family: inherit;
}
input:focus, select:focus { outline: none; border-color: #0f3460; }
.form-row { margin-bottom: 12px; }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.btn {
  padding: 8px 20px; border: none; border-radius: 6px; cursor: pointer;
  font-size: 14px; font-family: inherit; font-weight: 500;
  transition: background 0.2s;
}
.btn-primary { background: #0f3460; color: #fff; }
.btn-primary:hover { background: #1a4a7a; }
.btn-danger { background: #e94560; color: #fff; }
.btn-danger:hover { background: #d13350; }
.btn-secondary { background: #eee; color: #333; }
.btn-secondary:hover { background: #ddd; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-group { display: flex; gap: 8px; margin-top: 12px; }
table {
  width: 100%; border-collapse: collapse; font-size: 14px;
}
th, td { text-align: left; padding: 10px 12px; border-bottom: 1px solid #eee; }
th { font-weight: 600; color: #555; font-size: 13px; }
tr:hover { background: #f8f8f8; }
.toast-container {
  position: fixed; top: 16px; right: 16px; z-index: 1000;
  display: flex; flex-direction: column; gap: 8px;
}
.toast {
  padding: 12px 20px; border-radius: 6px; color: #fff;
  font-size: 14px; animation: slideIn 0.3s ease-out;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.toast.success { background: #4caf50; }
.toast.error { background: #e94560; }
.toast.info { background: #0f3460; }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
.status-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;
}
.status-item {
  text-align: center; padding: 16px; background: #f8f8f8; border-radius: 6px;
}
.status-item .value { font-size: 24px; font-weight: 700; color: #1a1a2e; }
.status-item .label { font-size: 12px; color: #888; margin-top: 4px; }
.modal-overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
  z-index: 500; justify-content: center; align-items: center;
}
.modal-overlay.active { display: flex; }
.modal {
  background: #fff; border-radius: 8px; padding: 24px;
  width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;
}
.modal h2 { margin-bottom: 16px; }
audio { width: 100%; margin-top: 8px; }
</style>
</head>
<body>

<div class="header">
  <h1>AI Meeting Proxy - Admin</h1>
  <div class="status-dot" id="statusDot" title="Checking..."></div>
</div>

<div class="tabs">
  <button class="tab-btn active" data-tab="profile">Profile</button>
  <button class="tab-btn" data-tab="tts">TTS</button>
  <button class="tab-btn" data-tab="knowledge">Knowledge</button>
  <button class="tab-btn" data-tab="bot">Bot Control</button>
</div>

<div class="container">

  <!-- Profile Tab -->
  <div class="panel active" id="panel-profile">
    <div class="card">
      <h2>Persona Profile</h2>
      <p style="font-size:13px;color:#888;margin-bottom:12px;">Markdown format. Changes are applied immediately to the avatar persona.</p>
      <textarea id="profileEditor" placeholder="Loading..."></textarea>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="saveProfile()">Save Profile</button>
        <button class="btn btn-secondary" onclick="loadProfile()">Reload</button>
      </div>
    </div>
  </div>

  <!-- TTS Tab -->
  <div class="panel" id="panel-tts">
    <div class="card">
      <h2>TTS Settings</h2>
      <div class="form-grid">
        <div class="form-row">
          <label>Voice Name</label>
          <input type="text" id="ttsVoiceName" placeholder="ja-JP-Neural2-B">
        </div>
        <div class="form-row">
          <label>Speaking Rate</label>
          <input type="number" id="ttsSpeakingRate" step="0.1" min="0.5" max="2.0" value="1.0">
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
      </div>
    </div>
    <div class="card">
      <h2>Voice Preview</h2>
      <div class="form-row">
        <label>Preview Text</label>
        <textarea id="ttsPreviewText" style="min-height:80px;" placeholder="Preview text...">こんにちは。音声プレビューのテストです。</textarea>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="previewTTS()">Play Preview</button>
      </div>
      <audio id="ttsAudio" controls style="display:none;"></audio>
    </div>
  </div>

  <!-- Knowledge Tab -->
  <div class="panel" id="panel-knowledge">
    <div class="card">
      <h2>Knowledge Base Documents</h2>
      <table>
        <thead><tr><th>Filename</th><th>Size</th><th>Actions</th></tr></thead>
        <tbody id="knowledgeTable"><tr><td colspan="3" style="color:#888;">Loading...</td></tr></tbody>
      </table>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="openNewDocModal()">Add Document</button>
        <button class="btn btn-secondary" onclick="loadKnowledge()">Refresh</button>
      </div>
    </div>
  </div>

  <!-- Bot Control Tab -->
  <div class="panel" id="panel-bot">
    <div class="card">
      <h2>System Status</h2>
      <div class="status-grid" id="statusGrid">
        <div class="status-item"><div class="value" id="st-tts">-</div><div class="label">TTS</div></div>
        <div class="status-item"><div class="value" id="st-persona">-</div><div class="label">Persona</div></div>
        <div class="status-item"><div class="value" id="st-docs">-</div><div class="label">Documents</div></div>
        <div class="status-item"><div class="value" id="st-sessions">-</div><div class="label">Sessions</div></div>
      </div>
    </div>
    <div class="card">
      <h2>Join Meeting</h2>
      <div class="form-row">
        <label>Google Meet URL</label>
        <input type="text" id="meetUrl" placeholder="https://meet.google.com/xxx-xxxx-xxx">
      </div>
      <div class="form-grid">
        <div class="form-row">
          <label>Bot Name</label>
          <input type="text" id="botName" placeholder="AI Avatar">
        </div>
        <div class="form-row">
          <label>Avatar Mode</label>
          <select id="avatarMode">
            <option value="true">Enabled (bidirectional audio)</option>
            <option value="false">Disabled (listen only)</option>
          </select>
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="joinMeeting()">Join Meeting</button>
      </div>
    </div>
    <div class="card">
      <h2>Active Bot</h2>
      <div class="form-row">
        <label>Bot ID</label>
        <input type="text" id="activeBotId" placeholder="Enter bot ID or join a meeting">
      </div>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="checkBotStatus()">Check Status</button>
        <button class="btn btn-danger" onclick="leaveMeeting()">Leave Meeting</button>
      </div>
      <pre id="botStatusOutput" style="margin-top:12px;font-size:13px;color:#555;white-space:pre-wrap;"></pre>
    </div>
    <div class="card">
      <h2>Response Triggers</h2>
      <div class="form-row">
        <label>Trigger Keywords (comma separated)</label>
        <input type="text" id="responseTriggers" placeholder="e.g. AI Avatar,avatar">
      </div>
      <div class="form-grid">
        <div class="form-row">
          <label>Silence Timeout (sec)</label>
          <input type="number" id="silenceTimeout" min="1" max="30" value="3">
        </div>
        <div class="form-row">
          <label>Max History</label>
          <input type="number" id="maxHistory" min="5" max="100" value="20">
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
      </div>
    </div>
  </div>

</div>

<!-- Doc Edit Modal -->
<div class="modal-overlay" id="docModal">
  <div class="modal">
    <h2 id="docModalTitle">New Document</h2>
    <div class="form-row">
      <label>Filename</label>
      <input type="text" id="docFilename" placeholder="document-name.md">
    </div>
    <div class="form-row">
      <label>Content</label>
      <textarea id="docContent" style="min-height:250px;" placeholder="Document content..."></textarea>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="saveDocument()">Save</button>
      <button class="btn btn-secondary" onclick="closeDocModal()">Cancel</button>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
const API_KEY = localStorage.getItem('admin_api_key') || '';
const headers = () => {
  const h = {'Content-Type': 'application/json'};
  if (API_KEY) h['X-API-Key'] = API_KEY;
  return h;
};

// Toast notifications
function toast(msg, type = 'info') {
  const el = document.createElement('div');
  el.className = 'toast ' + type;
  el.textContent = msg;
  document.getElementById('toastContainer').appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('panel-' + btn.dataset.tab).classList.add('active');
  });
});

// API helpers
async function api(method, path, body) {
  const opts = {method, headers: headers()};
  if (body !== undefined) opts.body = JSON.stringify(body);
  const resp = await fetch(path, opts);
  if (!resp.ok) {
    const err = await resp.json().catch(() => ({detail: resp.statusText}));
    throw new Error(err.detail || 'Request failed');
  }
  return resp;
}
async function apiJson(method, path, body) {
  const resp = await api(method, path, body);
  return resp.json();
}

// Profile
async function loadProfile() {
  try {
    const data = await apiJson('GET', '/admin/profile');
    document.getElementById('profileEditor').value = data.content || '';
  } catch (e) { toast(e.message, 'error'); }
}
async function saveProfile() {
  try {
    const content = document.getElementById('profileEditor').value;
    await apiJson('PUT', '/admin/profile', {content});
    toast('Profile saved', 'success');
  } catch (e) { toast(e.message, 'error'); }
}

// Settings
async function loadSettings() {
  try {
    const data = await apiJson('GET', '/admin/settings');
    document.getElementById('ttsVoiceName').value = data.tts_voice_name || '';
    document.getElementById('ttsSpeakingRate').value = data.tts_speaking_rate || 1.0;
    document.getElementById('responseTriggers').value = data.response_triggers || '';
    document.getElementById('silenceTimeout').value = data.silence_timeout_seconds || 3;
    document.getElementById('maxHistory').value = data.max_conversation_history || 20;
  } catch (e) { toast(e.message, 'error'); }
}
async function saveSettings() {
  try {
    await apiJson('PUT', '/admin/settings', {
      tts_voice_name: document.getElementById('ttsVoiceName').value,
      tts_speaking_rate: parseFloat(document.getElementById('ttsSpeakingRate').value),
      response_triggers: document.getElementById('responseTriggers').value,
      silence_timeout_seconds: parseInt(document.getElementById('silenceTimeout').value),
      max_conversation_history: parseInt(document.getElementById('maxHistory').value),
    });
    toast('Settings saved', 'success');
  } catch (e) { toast(e.message, 'error'); }
}

// TTS Preview
async function previewTTS() {
  try {
    const text = document.getElementById('ttsPreviewText').value.trim();
    if (!text) { toast('Enter preview text', 'error'); return; }
    const resp = await api('POST', '/admin/tts/preview', {text});
    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);
    const audio = document.getElementById('ttsAudio');
    audio.src = url;
    audio.style.display = 'block';
    audio.play();
  } catch (e) { toast(e.message, 'error'); }
}

// Knowledge
async function loadKnowledge() {
  try {
    const data = await apiJson('GET', '/admin/knowledge');
    const tbody = document.getElementById('knowledgeTable');
    if (!data.documents || data.documents.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3" style="color:#888;">No documents</td></tr>';
      return;
    }
    tbody.innerHTML = data.documents.map(doc => `
      <tr>
        <td>${esc(doc.filename)}</td>
        <td>${formatSize(doc.size)}</td>
        <td>
          <button class="btn btn-secondary" style="padding:4px 12px;font-size:12px;" onclick="editDocument('${esc(doc.filename)}')">Edit</button>
          <button class="btn btn-danger" style="padding:4px 12px;font-size:12px;" onclick="deleteDocument('${esc(doc.filename)}')">Delete</button>
        </td>
      </tr>
    `).join('');
  } catch (e) { toast(e.message, 'error'); }
}
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function formatSize(b) { return b < 1024 ? b + ' B' : (b / 1024).toFixed(1) + ' KB'; }

function openNewDocModal() {
  document.getElementById('docModalTitle').textContent = 'New Document';
  document.getElementById('docFilename').value = '';
  document.getElementById('docFilename').disabled = false;
  document.getElementById('docContent').value = '';
  document.getElementById('docModal').classList.add('active');
}
async function editDocument(filename) {
  try {
    const data = await apiJson('GET', '/admin/knowledge/' + encodeURIComponent(filename));
    document.getElementById('docModalTitle').textContent = 'Edit: ' + filename;
    document.getElementById('docFilename').value = filename;
    document.getElementById('docFilename').disabled = true;
    document.getElementById('docContent').value = data.content || '';
    document.getElementById('docModal').classList.add('active');
  } catch (e) { toast(e.message, 'error'); }
}
async function saveDocument() {
  try {
    const filename = document.getElementById('docFilename').value.trim();
    const content = document.getElementById('docContent').value;
    if (!filename) { toast('Filename is required', 'error'); return; }
    await apiJson('PUT', '/admin/knowledge/' + encodeURIComponent(filename), {content});
    toast('Document saved', 'success');
    closeDocModal();
    loadKnowledge();
  } catch (e) { toast(e.message, 'error'); }
}
async function deleteDocument(filename) {
  if (!confirm('Delete ' + filename + '?')) return;
  try {
    await apiJson('DELETE', '/admin/knowledge/' + encodeURIComponent(filename));
    toast('Document deleted', 'success');
    loadKnowledge();
  } catch (e) { toast(e.message, 'error'); }
}
function closeDocModal() { document.getElementById('docModal').classList.remove('active'); }

// Bot Control
async function loadStatus() {
  try {
    const data = await apiJson('GET', '/admin/status');
    document.getElementById('st-tts').textContent = data.tts_available ? 'OK' : 'OFF';
    document.getElementById('st-tts').style.color = data.tts_available ? '#4caf50' : '#e94560';
    document.getElementById('st-persona').textContent = data.persona_name || 'N/A';
    document.getElementById('st-docs').textContent = data.knowledge_docs;
    document.getElementById('st-sessions').textContent = data.active_sessions;
    const dot = document.getElementById('statusDot');
    dot.classList.toggle('ok', data.persona_loaded);
    dot.title = data.persona_loaded ? 'System OK' : 'Persona not loaded';
  } catch (e) {
    document.getElementById('statusDot').title = 'Connection error';
  }
}
async function joinMeeting() {
  try {
    const url = document.getElementById('meetUrl').value.trim();
    if (!url) { toast('Enter a Meet URL', 'error'); return; }
    const data = await apiJson('POST', '/bot/join', {
      meeting_url: url,
      enable_avatar: document.getElementById('avatarMode').value === 'true',
      bot_name: document.getElementById('botName').value.trim() || undefined,
    });
    document.getElementById('activeBotId').value = data.bot_id;
    toast('Bot joined: ' + data.bot_id, 'success');
  } catch (e) { toast(e.message, 'error'); }
}
async function checkBotStatus() {
  const botId = document.getElementById('activeBotId').value.trim();
  if (!botId) { toast('Enter a Bot ID', 'error'); return; }
  try {
    const data = await apiJson('GET', '/bot/' + encodeURIComponent(botId) + '/status');
    document.getElementById('botStatusOutput').textContent = JSON.stringify(data, null, 2);
  } catch (e) { toast(e.message, 'error'); }
}
async function leaveMeeting() {
  const botId = document.getElementById('activeBotId').value.trim();
  if (!botId) { toast('Enter a Bot ID', 'error'); return; }
  if (!confirm('Leave meeting?')) return;
  try {
    await apiJson('POST', '/bot/' + encodeURIComponent(botId) + '/leave');
    toast('Bot left the meeting', 'success');
    document.getElementById('botStatusOutput').textContent = '';
  } catch (e) { toast(e.message, 'error'); }
}

// API Key prompt
(function initApiKey() {
  if (!API_KEY) {
    const key = prompt('Enter API Key (leave empty if auth is disabled):');
    if (key) {
      localStorage.setItem('admin_api_key', key);
      location.reload();
    }
  }
})();

// Initial load
loadProfile();
loadSettings();
loadKnowledge();
loadStatus();
</script>
</body>
</html>
