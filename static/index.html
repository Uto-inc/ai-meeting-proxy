<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Meeting Proxy - Admin</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Meiryo", sans-serif;
  background: #f5f5f5; color: #333; line-height: 1.6;
}
.header {
  background: #1a1a2e; color: #fff; padding: 16px 24px;
  display: flex; align-items: center; gap: 12px;
}
.header h1 { font-size: 18px; font-weight: 600; }
.header .status-dot {
  width: 10px; height: 10px; border-radius: 50%; background: #666;
  margin-left: auto;
}
.header .status-dot.ok { background: #4caf50; }
.header .status-dot.google { background: #4285f4; }
.tabs {
  display: flex; background: #16213e; border-bottom: 2px solid #0f3460;
  overflow-x: auto;
}
.tab-btn {
  padding: 10px 20px; background: none; border: none; color: #aaa;
  cursor: pointer; font-size: 13px; font-family: inherit;
  border-bottom: 2px solid transparent; transition: all 0.2s;
  white-space: nowrap;
}
.tab-btn:hover { color: #ddd; background: rgba(255,255,255,0.05); }
.tab-btn.active { color: #fff; border-bottom-color: #e94560; }
.container { max-width: 1000px; margin: 0 auto; padding: 24px; }
.panel { display: none; }
.panel.active { display: block; }
.card {
  background: #fff; border-radius: 8px; padding: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px;
}
.card h2 { font-size: 16px; margin-bottom: 12px; color: #1a1a2e; }
.card h3 { font-size: 14px; margin-bottom: 8px; color: #555; }
label { display: block; font-size: 13px; color: #555; margin-bottom: 4px; font-weight: 500; }
textarea {
  width: 100%; min-height: 300px; padding: 12px;
  font-family: "SF Mono", "Fira Code", "Consolas", monospace;
  font-size: 13px; line-height: 1.5; border: 1px solid #ddd;
  border-radius: 6px; resize: vertical; background: #fafafa;
}
textarea:focus { outline: none; border-color: #0f3460; background: #fff; }
input[type="text"], input[type="number"], select, input[type="file"] {
  width: 100%; padding: 8px 12px; border: 1px solid #ddd;
  border-radius: 6px; font-size: 14px; font-family: inherit;
}
input:focus, select:focus { outline: none; border-color: #0f3460; }
.form-row { margin-bottom: 12px; }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.btn {
  padding: 8px 20px; border: none; border-radius: 6px; cursor: pointer;
  font-size: 14px; font-family: inherit; font-weight: 500;
  transition: background 0.2s;
}
.btn-primary { background: #0f3460; color: #fff; }
.btn-primary:hover { background: #1a4a7a; }
.btn-danger { background: #e94560; color: #fff; }
.btn-danger:hover { background: #d13350; }
.btn-secondary { background: #eee; color: #333; }
.btn-secondary:hover { background: #ddd; }
.btn-google { background: #4285f4; color: #fff; }
.btn-google:hover { background: #3367d6; }
.btn-success { background: #4caf50; color: #fff; }
.btn-success:hover { background: #43a047; }
.btn-export { background: #ff9800; color: #fff; }
.btn-export:hover { background: #f57c00; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-group { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
.btn-sm { padding: 4px 12px; font-size: 12px; }
table {
  width: 100%; border-collapse: collapse; font-size: 14px;
}
th, td { text-align: left; padding: 10px 12px; border-bottom: 1px solid #eee; }
th { font-weight: 600; color: #555; font-size: 13px; }
tr:hover { background: #f8f8f8; }
.toast-container {
  position: fixed; top: 16px; right: 16px; z-index: 1000;
  display: flex; flex-direction: column; gap: 8px;
}
.toast {
  padding: 12px 20px; border-radius: 6px; color: #fff;
  font-size: 14px; animation: slideIn 0.3s ease-out;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.toast.success { background: #4caf50; }
.toast.error { background: #e94560; }
.toast.info { background: #0f3460; }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
.status-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px;
}
.status-item {
  text-align: center; padding: 16px; background: #f8f8f8; border-radius: 6px;
}
.status-item .value { font-size: 20px; font-weight: 700; color: #1a1a2e; }
.status-item .label { font-size: 12px; color: #888; margin-top: 4px; }
.modal-overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
  z-index: 500; justify-content: center; align-items: center;
}
.modal-overlay.active { display: flex; }
.modal {
  background: #fff; border-radius: 8px; padding: 24px;
  width: 90%; max-width: 700px; max-height: 80vh; overflow-y: auto;
}
.modal h2 { margin-bottom: 16px; }
audio { width: 100%; margin-top: 8px; }
.badge {
  display: inline-block; padding: 2px 8px; border-radius: 10px;
  font-size: 11px; font-weight: 600;
}
.badge-on { background: #e8f5e9; color: #2e7d32; }
.badge-off { background: #fce4ec; color: #c62828; }
.badge-idle { background: #e3f2fd; color: #1565c0; }
.badge-joining { background: #fff3e0; color: #e65100; }
.badge-in_meeting { background: #e8f5e9; color: #2e7d32; }
.badge-draft { background: #e3f2fd; color: #1565c0; }
.badge-exported { background: #e8f5e9; color: #2e7d32; }
.toggle-switch {
  position: relative; display: inline-block; width: 44px; height: 24px;
}
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
  position: absolute; cursor: pointer; inset: 0;
  background: #ccc; border-radius: 24px; transition: 0.3s;
}
.toggle-slider:before {
  content: ""; position: absolute; height: 18px; width: 18px;
  left: 3px; bottom: 3px; background: #fff;
  border-radius: 50%; transition: 0.3s;
}
input:checked + .toggle-slider { background: #4caf50; }
input:checked + .toggle-slider:before { transform: translateX(20px); }
.event-row { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #eee; }
.event-info { flex: 1; }
.event-title { font-weight: 600; font-size: 14px; }
.event-time { font-size: 12px; color: #888; }
.event-meet { font-size: 12px; color: #4285f4; }
.event-actions { display: flex; align-items: center; gap: 8px; }
.materials-section { margin-top: 8px; padding-left: 16px; }
.material-item { display: flex; align-items: center; gap: 8px; font-size: 13px; padding: 4px 0; }
.expand-btn {
  background: none; border: none; cursor: pointer; font-size: 12px; color: #0f3460;
  text-decoration: underline; font-family: inherit;
}
.minutes-content { white-space: pre-wrap; font-size: 13px; line-height: 1.6; }
.conversation-entry { padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
.conversation-entry .speaker { font-weight: 600; font-size: 13px; }
.conversation-entry .text { font-size: 13px; color: #555; }
.conversation-entry .meta { font-size: 11px; color: #aaa; }
.conversation-entry.bot { background: #f0f7ff; border-radius: 6px; padding: 8px; }
</style>
</head>
<body>

<div class="header">
  <h1>AI Meeting Proxy</h1>
  <div class="status-dot" id="statusDot" title="Checking..."></div>
</div>

<div class="tabs">
  <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
  <button class="tab-btn" data-tab="calendar">Calendar</button>
  <button class="tab-btn" data-tab="history">Meeting History</button>
  <button class="tab-btn" data-tab="profile">Profile</button>
  <button class="tab-btn" data-tab="settings">Settings</button>
</div>

<div class="container">

  <!-- Dashboard Tab -->
  <div class="panel active" id="panel-dashboard">
    <div class="card">
      <h2>Google Account</h2>
      <div id="googleStatus">
        <p style="color:#888;">Checking connection...</p>
      </div>
      <div class="btn-group">
        <button class="btn btn-google" id="btnGoogleConnect" onclick="connectGoogle()">Connect Google Account</button>
        <button class="btn btn-danger btn-sm" id="btnGoogleDisconnect" onclick="disconnectGoogle()" style="display:none;">Disconnect</button>
      </div>
    </div>
    <div class="card">
      <h2>System Status</h2>
      <div class="status-grid" id="dashboardStatus">
        <div class="status-item"><div class="value" id="ds-tts">-</div><div class="label">TTS</div></div>
        <div class="status-item"><div class="value" id="ds-persona">-</div><div class="label">Persona</div></div>
        <div class="status-item"><div class="value" id="ds-docs">-</div><div class="label">Knowledge</div></div>
        <div class="status-item"><div class="value" id="ds-sessions">-</div><div class="label">Active Bots</div></div>
        <div class="status-item"><div class="value" id="ds-google">-</div><div class="label">Google</div></div>
      </div>
    </div>
    <div class="card">
      <h2>Upcoming AI Meetings</h2>
      <div id="upcomingMeetings"><p style="color:#888;">Connect Google to see upcoming meetings</p></div>
    </div>
  </div>

  <!-- Calendar Tab -->
  <div class="panel" id="panel-calendar">
    <div class="card">
      <h2>Calendar Events</h2>
      <div class="form-grid" style="margin-bottom:12px;">
        <div class="form-row">
          <label>Days Ahead</label>
          <select id="calDaysAhead">
            <option value="1">1 day</option>
            <option value="3">3 days</option>
            <option value="7" selected>7 days</option>
            <option value="14">14 days</option>
            <option value="30">30 days</option>
          </select>
        </div>
        <div class="form-row" style="display:flex;align-items:flex-end;">
          <button class="btn btn-primary" onclick="loadCalendarEvents()">Load Events</button>
          <button class="btn btn-secondary" style="margin-left:8px;" onclick="syncCalendar()">Force Sync</button>
        </div>
      </div>
      <div id="calendarEvents"><p style="color:#888;">Click "Load Events" to fetch from Google Calendar</p></div>
    </div>
  </div>

  <!-- Meeting History Tab -->
  <div class="panel" id="panel-history">
    <div class="card">
      <h2>Past Meetings</h2>
      <div id="meetingHistory"><p style="color:#888;">Loading...</p></div>
    </div>
  </div>

  <!-- Profile Tab -->
  <div class="panel" id="panel-profile">
    <div class="card">
      <h2>Persona Profile</h2>
      <p style="font-size:13px;color:#888;margin-bottom:12px;">Markdown format. Changes apply immediately to the avatar persona.</p>
      <textarea id="profileEditor" placeholder="Loading..."></textarea>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="saveProfile()">Save Profile</button>
        <button class="btn btn-secondary" onclick="loadProfile()">Reload</button>
      </div>
    </div>
  </div>

  <!-- Settings Tab -->
  <div class="panel" id="panel-settings">
    <div class="card">
      <h2>TTS Settings</h2>
      <div class="form-grid">
        <div class="form-row">
          <label>Voice Name</label>
          <input type="text" id="ttsVoiceName" placeholder="ja-JP-Neural2-B">
        </div>
        <div class="form-row">
          <label>Speaking Rate</label>
          <input type="number" id="ttsSpeakingRate" step="0.1" min="0.5" max="2.0" value="1.0">
        </div>
      </div>
      <div class="card" style="margin-top:12px;padding:12px;">
        <h3>Voice Preview</h3>
        <textarea id="ttsPreviewText" style="min-height:60px;">Preview test text.</textarea>
        <div class="btn-group">
          <button class="btn btn-primary btn-sm" onclick="previewTTS()">Play Preview</button>
        </div>
        <audio id="ttsAudio" controls style="display:none;"></audio>
      </div>
    </div>
    <div class="card">
      <h2>Bot Control</h2>
      <div class="form-row">
        <label>Response Triggers (comma separated)</label>
        <input type="text" id="responseTriggers" placeholder="e.g. AI Avatar,avatar">
      </div>
      <div class="form-grid">
        <div class="form-row">
          <label>Silence Timeout (sec)</label>
          <input type="number" id="silenceTimeout" min="1" max="30" value="3">
        </div>
        <div class="form-row">
          <label>Max History</label>
          <input type="number" id="maxHistory" min="5" max="100" value="20">
        </div>
      </div>
    </div>
    <div class="card">
      <h2>Manual Bot Join</h2>
      <div class="form-row">
        <label>Google Meet URL</label>
        <input type="text" id="meetUrl" placeholder="https://meet.google.com/xxx-xxxx-xxx">
      </div>
      <div class="form-grid">
        <div class="form-row">
          <label>Bot Name</label>
          <input type="text" id="botName" placeholder="AI Avatar">
        </div>
        <div class="form-row">
          <label>Avatar Mode</label>
          <select id="avatarMode">
            <option value="true">Enabled (bidirectional audio)</option>
            <option value="false">Disabled (listen only)</option>
          </select>
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="joinMeeting()">Join Meeting</button>
      </div>
    </div>
    <div class="card">
      <h2>Active Bot</h2>
      <div class="form-row">
        <label>Bot ID</label>
        <input type="text" id="activeBotId" placeholder="Enter bot ID or join a meeting">
      </div>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="checkBotStatus()">Check Status</button>
        <button class="btn btn-danger" onclick="leaveMeeting()">Leave Meeting</button>
      </div>
      <pre id="botStatusOutput" style="margin-top:12px;font-size:13px;color:#555;white-space:pre-wrap;"></pre>
    </div>
    <div class="card">
      <h2>Knowledge Base</h2>
      <table>
        <thead><tr><th>Filename</th><th>Size</th><th>Actions</th></tr></thead>
        <tbody id="knowledgeTable"><tr><td colspan="3" style="color:#888;">Loading...</td></tr></tbody>
      </table>
      <div class="btn-group">
        <button class="btn btn-primary btn-sm" onclick="openNewDocModal()">Add Document</button>
        <button class="btn btn-secondary btn-sm" onclick="loadKnowledge()">Refresh</button>
      </div>
    </div>
    <div class="btn-group" style="margin-top:16px;">
      <button class="btn btn-primary" onclick="saveSettings()">Save All Settings</button>
    </div>
  </div>

</div>

<!-- Doc Edit Modal -->
<div class="modal-overlay" id="docModal">
  <div class="modal">
    <h2 id="docModalTitle">New Document</h2>
    <div class="form-row">
      <label>Filename</label>
      <input type="text" id="docFilename" placeholder="document-name.md">
    </div>
    <div class="form-row">
      <label>Content</label>
      <textarea id="docContent" style="min-height:250px;" placeholder="Document content..."></textarea>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="saveDocument()">Save</button>
      <button class="btn btn-secondary" onclick="closeDocModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Material Upload Modal -->
<div class="modal-overlay" id="materialModal">
  <div class="modal">
    <h2>Upload Material</h2>
    <input type="hidden" id="materialMeetingId">
    <div class="form-row">
      <label>File (PDF, MD, TXT)</label>
      <input type="file" id="materialFile" accept=".pdf,.md,.txt,.markdown">
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="uploadMaterial()">Upload</button>
      <button class="btn btn-secondary" onclick="closeMaterialModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Drive Link Modal -->
<div class="modal-overlay" id="driveModal">
  <div class="modal">
    <h2>Link Google Drive File</h2>
    <input type="hidden" id="driveMeetingId">
    <div class="form-row">
      <label>Google Drive File ID</label>
      <input type="text" id="driveFileId" placeholder="Enter the file ID from the Drive URL">
      <p style="font-size:11px;color:#888;margin-top:4px;">
        From URL: docs.google.com/document/d/<strong>FILE_ID</strong>/edit
      </p>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="linkDriveMaterial()">Link</button>
      <button class="btn btn-secondary" onclick="closeDriveModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Minutes Modal -->
<div class="modal-overlay" id="minutesModal">
  <div class="modal" style="max-width:800px;">
    <h2 id="minutesTitle">Meeting Minutes</h2>
    <div id="minutesContent" class="minutes-content">Loading...</div>
    <div class="btn-group">
      <button class="btn btn-export" onclick="exportMinutes()">Export to Google Docs</button>
      <button class="btn btn-secondary" onclick="closeMinutesModal()">Close</button>
    </div>
  </div>
</div>

<!-- Conversation Log Modal -->
<div class="modal-overlay" id="conversationModal">
  <div class="modal" style="max-width:800px;">
    <h2>Conversation Log</h2>
    <div id="conversationContent">Loading...</div>
    <div class="btn-group">
      <button class="btn btn-secondary" onclick="closeConversationModal()">Close</button>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
const API_KEY = localStorage.getItem('admin_api_key') || '';
const headers = () => {
  const h = {'Content-Type': 'application/json'};
  if (API_KEY) h['X-API-Key'] = API_KEY;
  return h;
};

let currentMinutesMeetingId = null;

function toast(msg, type = 'info') {
  const el = document.createElement('div');
  el.className = 'toast ' + type;
  el.textContent = msg;
  document.getElementById('toastContainer').appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function formatSize(b) { return b < 1024 ? b + ' B' : (b / 1024).toFixed(1) + ' KB'; }
function formatTime(iso) {
  if (!iso) return '';
  const d = new Date(iso);
  return d.toLocaleString('ja-JP', {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
}

// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('panel-' + btn.dataset.tab).classList.add('active');
  });
});

// API helpers
async function api(method, path, body) {
  const opts = {method, headers: headers()};
  if (body !== undefined) opts.body = JSON.stringify(body);
  const resp = await fetch(path, opts);
  if (!resp.ok) {
    const err = await resp.json().catch(() => ({detail: resp.statusText}));
    throw new Error(err.detail || 'Request failed');
  }
  return resp;
}
async function apiJson(method, path, body) {
  return (await api(method, path, body)).json();
}

// ======== DASHBOARD ========
async function checkGoogleAuth() {
  try {
    const data = await apiJson('GET', '/auth/google/status');
    const el = document.getElementById('googleStatus');
    const dot = document.getElementById('statusDot');
    const ds = document.getElementById('ds-google');
    if (data.authenticated) {
      el.innerHTML = '<p style="color:#4caf50;font-weight:600;">Connected</p><p style="font-size:12px;color:#888;">Expires: ' + esc(data.expires || '') + '</p>';
      document.getElementById('btnGoogleConnect').style.display = 'none';
      document.getElementById('btnGoogleDisconnect').style.display = '';
      dot.classList.add('google');
      if (ds) ds.textContent = 'Connected';
      if (ds) ds.style.color = '#4caf50';
      return true;
    } else {
      el.innerHTML = '<p style="color:#888;">Not connected</p>';
      document.getElementById('btnGoogleConnect').style.display = '';
      document.getElementById('btnGoogleDisconnect').style.display = 'none';
      if (ds) ds.textContent = 'Off';
      if (ds) ds.style.color = '#e94560';
      return false;
    }
  } catch (e) {
    document.getElementById('ds-google').textContent = 'Error';
    return false;
  }
}

function connectGoogle() { window.location.href = '/auth/google/login'; }

async function disconnectGoogle() {
  if (!confirm('Disconnect Google account?')) return;
  try {
    await apiJson('POST', '/auth/google/revoke');
    toast('Google account disconnected', 'success');
    checkGoogleAuth();
  } catch (e) { toast(e.message, 'error'); }
}

async function loadDashboardStatus() {
  try {
    const data = await apiJson('GET', '/admin/status');
    document.getElementById('ds-tts').textContent = data.tts_available ? 'OK' : 'OFF';
    document.getElementById('ds-tts').style.color = data.tts_available ? '#4caf50' : '#e94560';
    document.getElementById('ds-persona').textContent = data.persona_name || 'N/A';
    document.getElementById('ds-docs').textContent = data.knowledge_docs;
    document.getElementById('ds-sessions').textContent = data.active_sessions;
    const dot = document.getElementById('statusDot');
    dot.classList.toggle('ok', data.persona_loaded);
  } catch (e) {}
}

async function loadUpcomingAIMeetings() {
  try {
    const data = await apiJson('GET', '/calendar/events?days_ahead=3');
    const el = document.getElementById('upcomingMeetings');
    const aiEvents = (data.events || []).filter(e => e.ai_enabled);
    if (aiEvents.length === 0) {
      el.innerHTML = '<p style="color:#888;">No AI-enabled meetings in the next 3 days</p>';
      return;
    }
    el.innerHTML = aiEvents.map(e => `
      <div class="event-row">
        <div class="event-info">
          <div class="event-title">${esc(e.title)}</div>
          <div class="event-time">${formatTime(e.start_time)} - ${formatTime(e.end_time)}</div>
          <span class="badge badge-${e.bot_status}">${esc(e.bot_status)}</span>
        </div>
      </div>
    `).join('');
  } catch (e) {
    document.getElementById('upcomingMeetings').innerHTML = '<p style="color:#888;">Connect Google to see upcoming meetings</p>';
  }
}

// ======== CALENDAR ========
async function loadCalendarEvents() {
  const days = document.getElementById('calDaysAhead').value;
  try {
    const data = await apiJson('GET', '/calendar/events?days_ahead=' + days);
    renderCalendarEvents(data.events || []);
  } catch (e) { toast(e.message, 'error'); }
}

async function syncCalendar() {
  try {
    const days = document.getElementById('calDaysAhead').value;
    const data = await apiJson('POST', '/calendar/sync?days_ahead=' + days);
    toast('Synced ' + data.synced + ' events', 'success');
    loadCalendarEvents();
  } catch (e) { toast(e.message, 'error'); }
}

function renderCalendarEvents(events) {
  const el = document.getElementById('calendarEvents');
  if (events.length === 0) {
    el.innerHTML = '<p style="color:#888;">No events found</p>';
    return;
  }
  el.innerHTML = events.map(e => `
    <div class="event-row" data-event-id="${esc(e.id)}">
      <div class="event-info">
        <div class="event-title">${esc(e.title)}</div>
        <div class="event-time">${formatTime(e.start_time)} - ${formatTime(e.end_time)}</div>
        ${e.meeting_url ? '<div class="event-meet">Google Meet</div>' : '<div style="font-size:12px;color:#ccc;">No Meet URL</div>'}
        <button class="expand-btn" onclick="toggleMaterials('${esc(e.id)}')">Materials</button>
        <div class="materials-section" id="materials-${esc(e.id)}" style="display:none;"></div>
      </div>
      <div class="event-actions">
        <span class="badge badge-${e.bot_status || 'idle'}">${esc(e.bot_status || 'idle')}</span>
        <label class="toggle-switch" title="${e.meeting_url ? 'Toggle AI' : 'No Meet URL'}">
          <input type="checkbox" ${e.ai_enabled ? 'checked' : ''} ${e.meeting_url ? '' : 'disabled'}
            onchange="toggleAI('${esc(e.id)}', this.checked)">
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>
  `).join('');
}

async function toggleAI(eventId, enabled) {
  try {
    const action = enabled ? 'enable-ai' : 'disable-ai';
    await apiJson('POST', '/calendar/events/' + encodeURIComponent(eventId) + '/' + action);
    toast(enabled ? 'AI enabled' : 'AI disabled', 'success');
  } catch (e) {
    toast(e.message, 'error');
    loadCalendarEvents();
  }
}

async function toggleMaterials(meetingId) {
  const el = document.getElementById('materials-' + meetingId);
  if (el.style.display !== 'none') { el.style.display = 'none'; return; }
  el.style.display = 'block';
  el.innerHTML = '<p style="font-size:12px;color:#888;">Loading...</p>';
  try {
    const data = await apiJson('GET', '/meetings/' + encodeURIComponent(meetingId) + '/materials');
    const mats = data.materials || [];
    let html = mats.map(m => `
      <div class="material-item">
        <span>${esc(m.filename)}</span>
        <span class="badge badge-${m.status === 'extracted' ? 'on' : 'off'}">${esc(m.status)}</span>
        <button class="btn btn-danger btn-sm" onclick="deleteMaterial('${esc(meetingId)}', ${m.id})">Delete</button>
      </div>
    `).join('');
    html += `
      <div class="btn-group" style="margin-top:8px;">
        <button class="btn btn-primary btn-sm" onclick="openMaterialUpload('${esc(meetingId)}')">Upload File</button>
        <button class="btn btn-google btn-sm" onclick="openDriveLink('${esc(meetingId)}')">Link Drive</button>
      </div>
    `;
    el.innerHTML = html;
  } catch (e) { el.innerHTML = '<p style="color:#e94560;font-size:12px;">' + esc(e.message) + '</p>'; }
}

function openMaterialUpload(meetingId) {
  document.getElementById('materialMeetingId').value = meetingId;
  document.getElementById('materialFile').value = '';
  document.getElementById('materialModal').classList.add('active');
}
function closeMaterialModal() { document.getElementById('materialModal').classList.remove('active'); }

async function uploadMaterial() {
  const meetingId = document.getElementById('materialMeetingId').value;
  const fileInput = document.getElementById('materialFile');
  if (!fileInput.files.length) { toast('Select a file', 'error'); return; }
  const formData = new FormData();
  formData.append('file', fileInput.files[0]);
  try {
    const resp = await fetch('/meetings/' + encodeURIComponent(meetingId) + '/materials/upload', {
      method: 'POST',
      headers: API_KEY ? {'X-API-Key': API_KEY} : {},
      body: formData,
    });
    if (!resp.ok) throw new Error((await resp.json()).detail || 'Upload failed');
    const data = await resp.json();
    toast('Uploaded: ' + data.filename + ' (' + data.extracted_length + ' chars extracted)', 'success');
    closeMaterialModal();
    toggleMaterials(meetingId);
    toggleMaterials(meetingId);
  } catch (e) { toast(e.message, 'error'); }
}

function openDriveLink(meetingId) {
  document.getElementById('driveMeetingId').value = meetingId;
  document.getElementById('driveFileId').value = '';
  document.getElementById('driveModal').classList.add('active');
}
function closeDriveModal() { document.getElementById('driveModal').classList.remove('active'); }

async function linkDriveMaterial() {
  const meetingId = document.getElementById('driveMeetingId').value;
  const fileId = document.getElementById('driveFileId').value.trim();
  if (!fileId) { toast('Enter a file ID', 'error'); return; }
  try {
    const data = await apiJson('POST', '/meetings/' + encodeURIComponent(meetingId) + '/materials/drive', {file_id: fileId});
    toast('Linked: ' + data.filename, 'success');
    closeDriveModal();
    toggleMaterials(meetingId);
    toggleMaterials(meetingId);
  } catch (e) { toast(e.message, 'error'); }
}

async function deleteMaterial(meetingId, materialId) {
  if (!confirm('Delete this material?')) return;
  try {
    await apiJson('DELETE', '/meetings/' + encodeURIComponent(meetingId) + '/materials/' + materialId);
    toast('Material deleted', 'success');
    toggleMaterials(meetingId);
    toggleMaterials(meetingId);
  } catch (e) { toast(e.message, 'error'); }
}

// ======== MEETING HISTORY ========
async function loadMeetingHistory() {
  try {
    const data = await apiJson('GET', '/calendar/events?days_ahead=30');
    const el = document.getElementById('meetingHistory');
    const events = (data.events || []).filter(e => e.bot_status && e.bot_status !== 'idle');
    if (events.length === 0) {
      el.innerHTML = '<p style="color:#888;">No meeting history yet</p>';
      return;
    }
    el.innerHTML = events.map(e => `
      <div class="event-row">
        <div class="event-info">
          <div class="event-title">${esc(e.title)}</div>
          <div class="event-time">${formatTime(e.start_time)} - ${formatTime(e.end_time)}</div>
          <span class="badge badge-${e.bot_status}">${esc(e.bot_status)}</span>
        </div>
        <div class="event-actions">
          <button class="btn btn-secondary btn-sm" onclick="showConversation('${esc(e.id)}')">Log</button>
          <button class="btn btn-primary btn-sm" onclick="showMinutes('${esc(e.id)}', '${esc(e.title)}')">Minutes</button>
          <button class="btn btn-success btn-sm" onclick="generateMinutes('${esc(e.id)}')">Generate</button>
        </div>
      </div>
    `).join('');
  } catch (e) {
    document.getElementById('meetingHistory').innerHTML = '<p style="color:#888;">Connect Google to see history</p>';
  }
}

async function showConversation(meetingId) {
  document.getElementById('conversationModal').classList.add('active');
  document.getElementById('conversationContent').innerHTML = '<p style="color:#888;">Loading...</p>';
  try {
    const data = await apiJson('GET', '/meetings/' + encodeURIComponent(meetingId) + '/minutes');
    // Try to get conversation from the log
    // For now show from minutes data
    const el = document.getElementById('conversationContent');
    el.innerHTML = '<p style="color:#888;">Conversation log not directly available via API. View minutes instead.</p>';
  } catch (e) {
    document.getElementById('conversationContent').innerHTML = '<p style="color:#e94560;">' + esc(e.message) + '</p>';
  }
}
function closeConversationModal() { document.getElementById('conversationModal').classList.remove('active'); }

async function generateMinutes(meetingId) {
  toast('Generating minutes...', 'info');
  try {
    const data = await apiJson('POST', '/meetings/' + encodeURIComponent(meetingId) + '/minutes/generate');
    toast('Minutes generated', 'success');
    showMinutes(meetingId, '');
  } catch (e) { toast(e.message, 'error'); }
}

async function showMinutes(meetingId, title) {
  currentMinutesMeetingId = meetingId;
  document.getElementById('minutesModal').classList.add('active');
  document.getElementById('minutesTitle').textContent = 'Minutes: ' + (title || meetingId);
  document.getElementById('minutesContent').innerHTML = '<p style="color:#888;">Loading...</p>';
  try {
    const data = await apiJson('GET', '/meetings/' + encodeURIComponent(meetingId) + '/minutes');
    let html = '';
    if (data.summary) html += '<h3>Summary</h3><p>' + esc(data.summary) + '</p>';
    if (data.answered_items && data.answered_items.length) {
      html += '<h3>Answered Items</h3><ul>' + data.answered_items.map(i =>
        '<li><strong>' + esc(i.question || i.topic || '') + '</strong>: ' + esc(i.answer || '') + '</li>'
      ).join('') + '</ul>';
    }
    if (data.taken_back_items && data.taken_back_items.length) {
      html += '<h3>Taken Back Items</h3><ul>' + data.taken_back_items.map(i =>
        '<li><strong>' + esc(i.topic || '') + '</strong>: ' + esc(i.reason || '') + '</li>'
      ).join('') + '</ul>';
    }
    if (data.action_items && data.action_items.length) {
      html += '<h3>Action Items</h3><ul>' + data.action_items.map(i =>
        '<li>' + esc(i.task || '') + ' (' + esc(i.owner || '?') + ')</li>'
      ).join('') + '</ul>';
    }
    if (data.google_doc_url) {
      html += '<p style="margin-top:12px;"><a href="' + esc(data.google_doc_url) + '" target="_blank">Open in Google Docs</a></p>';
    }
    document.getElementById('minutesContent').innerHTML = html || '<p style="color:#888;">No minutes found. Click "Generate" first.</p>';
  } catch (e) {
    document.getElementById('minutesContent').innerHTML = '<p style="color:#888;">No minutes found. Click "Generate" on the history page.</p>';
  }
}
function closeMinutesModal() { document.getElementById('minutesModal').classList.remove('active'); }

async function exportMinutes() {
  if (!currentMinutesMeetingId) return;
  toast('Exporting to Google Docs...', 'info');
  try {
    const data = await apiJson('POST', '/meetings/' + encodeURIComponent(currentMinutesMeetingId) + '/minutes/export');
    toast('Exported!', 'success');
    if (data.google_doc_url) window.open(data.google_doc_url, '_blank');
  } catch (e) { toast(e.message, 'error'); }
}

// ======== PROFILE ========
async function loadProfile() {
  try {
    const data = await apiJson('GET', '/admin/profile');
    document.getElementById('profileEditor').value = data.content || '';
  } catch (e) { toast(e.message, 'error'); }
}
async function saveProfile() {
  try {
    const content = document.getElementById('profileEditor').value;
    await apiJson('PUT', '/admin/profile', {content});
    toast('Profile saved', 'success');
  } catch (e) { toast(e.message, 'error'); }
}

// ======== SETTINGS ========
async function loadSettings() {
  try {
    const data = await apiJson('GET', '/admin/settings');
    document.getElementById('ttsVoiceName').value = data.tts_voice_name || '';
    document.getElementById('ttsSpeakingRate').value = data.tts_speaking_rate || 1.0;
    document.getElementById('responseTriggers').value = data.response_triggers || '';
    document.getElementById('silenceTimeout').value = data.silence_timeout_seconds || 3;
    document.getElementById('maxHistory').value = data.max_conversation_history || 20;
  } catch (e) { toast(e.message, 'error'); }
}
async function saveSettings() {
  try {
    await apiJson('PUT', '/admin/settings', {
      tts_voice_name: document.getElementById('ttsVoiceName').value,
      tts_speaking_rate: parseFloat(document.getElementById('ttsSpeakingRate').value),
      response_triggers: document.getElementById('responseTriggers').value,
      silence_timeout_seconds: parseInt(document.getElementById('silenceTimeout').value),
      max_conversation_history: parseInt(document.getElementById('maxHistory').value),
    });
    toast('Settings saved', 'success');
  } catch (e) { toast(e.message, 'error'); }
}
async function previewTTS() {
  try {
    const text = document.getElementById('ttsPreviewText').value.trim();
    if (!text) { toast('Enter preview text', 'error'); return; }
    const resp = await api('POST', '/admin/tts/preview', {text});
    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);
    const audio = document.getElementById('ttsAudio');
    audio.src = url; audio.style.display = 'block'; audio.play();
  } catch (e) { toast(e.message, 'error'); }
}

// ======== KNOWLEDGE ========
async function loadKnowledge() {
  try {
    const data = await apiJson('GET', '/admin/knowledge');
    const tbody = document.getElementById('knowledgeTable');
    if (!data.documents || data.documents.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3" style="color:#888;">No documents</td></tr>';
      return;
    }
    tbody.innerHTML = data.documents.map(doc => `
      <tr>
        <td>${esc(doc.filename)}</td>
        <td>${formatSize(doc.size)}</td>
        <td>
          <button class="btn btn-secondary btn-sm" onclick="editDocument('${esc(doc.filename)}')">Edit</button>
          <button class="btn btn-danger btn-sm" onclick="deleteDocument('${esc(doc.filename)}')">Delete</button>
        </td>
      </tr>
    `).join('');
  } catch (e) { toast(e.message, 'error'); }
}
function openNewDocModal() {
  document.getElementById('docModalTitle').textContent = 'New Document';
  document.getElementById('docFilename').value = '';
  document.getElementById('docFilename').disabled = false;
  document.getElementById('docContent').value = '';
  document.getElementById('docModal').classList.add('active');
}
async function editDocument(filename) {
  try {
    const data = await apiJson('GET', '/admin/knowledge/' + encodeURIComponent(filename));
    document.getElementById('docModalTitle').textContent = 'Edit: ' + filename;
    document.getElementById('docFilename').value = filename;
    document.getElementById('docFilename').disabled = true;
    document.getElementById('docContent').value = data.content || '';
    document.getElementById('docModal').classList.add('active');
  } catch (e) { toast(e.message, 'error'); }
}
async function saveDocument() {
  try {
    const filename = document.getElementById('docFilename').value.trim();
    const content = document.getElementById('docContent').value;
    if (!filename) { toast('Filename is required', 'error'); return; }
    await apiJson('PUT', '/admin/knowledge/' + encodeURIComponent(filename), {content});
    toast('Document saved', 'success');
    closeDocModal(); loadKnowledge();
  } catch (e) { toast(e.message, 'error'); }
}
async function deleteDocument(filename) {
  if (!confirm('Delete ' + filename + '?')) return;
  try {
    await apiJson('DELETE', '/admin/knowledge/' + encodeURIComponent(filename));
    toast('Document deleted', 'success'); loadKnowledge();
  } catch (e) { toast(e.message, 'error'); }
}
function closeDocModal() { document.getElementById('docModal').classList.remove('active'); }

// ======== BOT CONTROL ========
async function joinMeeting() {
  try {
    const url = document.getElementById('meetUrl').value.trim();
    if (!url) { toast('Enter a Meet URL', 'error'); return; }
    const data = await apiJson('POST', '/bot/join', {
      meeting_url: url,
      enable_avatar: document.getElementById('avatarMode').value === 'true',
      bot_name: document.getElementById('botName').value.trim() || undefined,
    });
    document.getElementById('activeBotId').value = data.bot_id;
    toast('Bot joined: ' + data.bot_id, 'success');
  } catch (e) { toast(e.message, 'error'); }
}
async function checkBotStatus() {
  const botId = document.getElementById('activeBotId').value.trim();
  if (!botId) { toast('Enter a Bot ID', 'error'); return; }
  try {
    const data = await apiJson('GET', '/bot/' + encodeURIComponent(botId) + '/status');
    document.getElementById('botStatusOutput').textContent = JSON.stringify(data, null, 2);
  } catch (e) { toast(e.message, 'error'); }
}
async function leaveMeeting() {
  const botId = document.getElementById('activeBotId').value.trim();
  if (!botId) { toast('Enter a Bot ID', 'error'); return; }
  if (!confirm('Leave meeting?')) return;
  try {
    await apiJson('POST', '/bot/' + encodeURIComponent(botId) + '/leave');
    toast('Bot left the meeting', 'success');
    document.getElementById('botStatusOutput').textContent = '';
  } catch (e) { toast(e.message, 'error'); }
}

// ======== INIT ========
(function initApiKey() {
  if (!API_KEY) {
    const key = prompt('Enter API Key (leave empty if auth is disabled):');
    if (key) { localStorage.setItem('admin_api_key', key); location.reload(); }
  }
})();

// Handle OAuth callback
if (new URLSearchParams(window.location.search).get('auth') === 'success') {
  toast('Google account connected!', 'success');
  history.replaceState({}, '', '/static/index.html');
}

// Load initial data
loadProfile();
loadSettings();
loadKnowledge();
loadDashboardStatus();
checkGoogleAuth().then(auth => {
  if (auth) {
    loadUpcomingAIMeetings();
    loadMeetingHistory();
  }
});
</script>
</body>
</html>
